<!DOCTYPE html><html><head><meta name="viewport" content="width=device-width"/><meta charSet="utf-8"/><title>Yangger Blog | undefined</title><meta property="og:title" content="Yangger Blog | undefined"/><meta name="twitter:title" content="Yangger Blog | undefined"/><meta name="description" content="Yangger的博客"/><meta property="og:description" content="Yangger的博客"/><meta name="twitter:description" content="Yangger的博客"/><meta property="og:image" content="http://admin.yangger.me/uploads/default_image_fb02149608.png"/><meta name="twitter:image" content="http://admin.yangger.me/uploads/default_image_fb02149608.png"/><meta name="image" content="http://admin.yangger.me/uploads/default_image_fb02149608.png"/><meta name="twitter:card" content="summary_large_image"/><meta name="next-head-count" content="12"/><link rel="preload" href="https://cdn.yangger.cn/_next/static/css/27838d0620568f600217.css" as="style"/><link rel="stylesheet" href="https://cdn.yangger.cn/_next/static/css/27838d0620568f600217.css" data-n-g=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="https://cdn.yangger.cn/_next/static/chunks/polyfills-a54b4f32bdc1ef890ddd.js"></script><script src="https://cdn.yangger.cn/_next/static/chunks/webpack-fca13b024832de4f9165.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/framework-92300432a1172ef1338b.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/main-4777350f2a9ff73ea2b0.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/pages/_app-0d329f71441799666960.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/951-4301b1d6b4e0621d5def.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/344-e076dfeee38c48fd427b.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/chunks/pages/%5Bslug%5D-e61c86dbf249d28e2ead.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/jcy5ipSxzxBmo7PK3zeT2/_buildManifest.js" defer=""></script><script src="https://cdn.yangger.cn/_next/static/jcy5ipSxzxBmo7PK3zeT2/_ssgManifest.js" defer=""></script></head><body><div id="__next"><div class="flex flex-wrap"><aside class="flex flex-wrap flex-col w-full relative lg:w-275/16 lg:h-auto lg:border-r dark:border-primary lg:pl-px24"><div class="profile flex w-full relative lg:h-px250 lg:border-b dark:border-primary"><div class="absolute top-px29 left-px17 flex flex-wrap items-center z-20 lg:top-px33 lg:left-0 lg:w-px230 lg:h-px33 xl:top-px40 xl:w-px278 xl:h-px40"><div style="display:inline-block;max-width:100%;overflow:hidden;position:relative;box-sizing:border-box;margin:0"><div style="box-sizing:border-box;display:block;max-width:100%"><img style="max-width:100%;display:block;margin:0;border:none;padding:0" alt="" aria-hidden="true" role="presentation" src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTc3IiBoZWlnaHQ9IjMzIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZlcnNpb249IjEuMSIvPg=="/></div><noscript><img alt="logo" srcSet="_next/static/image/public/dark-logo.982b262378b503d5085e0bfeaf430077.svg?auto=format&amp;fit=max&amp;w=256 1x, _next/static/image/public/dark-logo.982b262378b503d5085e0bfeaf430077.svg?auto=format&amp;fit=max&amp;w=384 2x" src="_next/static/image/public/dark-logo.982b262378b503d5085e0bfeaf430077.svg?auto=format&amp;fit=max&amp;w=384" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%" class="w-px203 h-px29"/></noscript><img alt="logo" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" class="w-px203 h-px29" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div><div class="rounded-full ml-px10 w-px10 h-px10 transition-all dark:bg-white"></div><p class="text-primary w-full mt-px16 font-medium text-base hidden">Personal profile</p></div><div class="absolute transition-all z-10 top-0 left-0 lg:-ml-px24 lg:pl-px24 w-full h-1/2 bg-gradient-to-b from-black to-transparent opacity-100 lg:opacity-0"></div><div class="person flex mx-auto justify-center w-full"><div style="display:block;overflow:hidden;position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;margin:0"><noscript><img alt="person" sizes="100vw" srcSet="_next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=640 640w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=750 750w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=828 828w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=1080 1080w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=1200 1200w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=1920 1920w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=2048 2048w, _next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=3840 3840w" src="_next/static/image/public/dark-person.3384c51bef8dc14a1866c96d4fde83fd.svg?auto=format&amp;fit=max&amp;w=3840" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></noscript><img alt="person" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" decoding="async" style="position:absolute;top:0;left:0;bottom:0;right:0;box-sizing:border-box;padding:0;border:none;margin:auto;display:block;width:0;height:0;min-width:100%;max-width:100%;min-height:100%;max-height:100%"/></div></div></div><div class="tag-list w-full relative border-b dark:border-primary hidden lg:flex"><div class="inner flex-col gap-y-px10 h-px300 flex w-full overflow-y-scroll overflow-x-hidden"><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer mt-px40">#<!-- -->BABEL<!-- --> (<!-- -->2<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->WEBPACK<!-- --> (<!-- -->2<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->NGINX<!-- --> (<!-- -->1<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->SSR<!-- --> (<!-- -->1<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->ELEMENT-UI<!-- --> (<!-- -->1<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->TYPESCRIPT<!-- --> (<!-- -->1<!-- -->)</div><div class="text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer">#<!-- -->MARKDOWN<!-- --> (<!-- -->1<!-- -->)</div></div><div class="absolute z-10 bottom-0 left-0 w-full h-1/2 bg-gradient-to-b from-transparent to-black pointer-events-none"></div></div><div class="subscribe w-full relative hidden lg:flex pt-px40 gap-y-px20 flex-col"><div class="flex items-center text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer"><iconpark-icon color="#7BF0BE" size="28" name="mail"></iconpark-icon><span class="mx-px10">·</span><span>E-mail</span></div><div class="flex items-center text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer"><iconpark-icon color="#7BF0BE" size="28" name="dribbble"></iconpark-icon><span class="mx-px10">·</span><span>Dribbble</span></div><div class="flex items-center text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer"><iconpark-icon color="#7BF0BE" size="28" name="github"></iconpark-icon><span class="mx-px10">·</span><span>Github</span></div><div class="flex items-center text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer"><iconpark-icon color="#7BF0BE" size="28" name="sina"></iconpark-icon><span class="mx-px10">·</span><span>Sina</span></div><div class="flex items-center text-base dark:text-primary transform hover:translate-x-px6 transition-all hover:text-white cursor-pointer"><iconpark-icon color="#7BF0BE" size="28" name="twitter"></iconpark-icon><span class="mx-px10">·</span><span>Twitter</span></div></div></aside><div class="flex flex-wrap flex-1 flex-col min-h-screen"><main class="flex flex-wrap flex-row relative mx-5 md:mx-16 space-x-0"><article class="dark:text-white"><header class="mb-2 mt-px60"><div class="date text-xs leading-5 dark:text-grayGreen">2021 / 02 / 05</div><h1 class="text-2xl leading-10/15 md:leading-10/15 font-bold dark:text-white cursor-pointer transition-all dark:hover:text-primary md:text-4xl">webpack2.6升级ts支持</h1><p class="mt-px16 mb-px24 text-opacity-80 text-white flex items-center gap-px8"><span class="text-sm">本文字数: <!-- -->8590</span><span class="text-sm">阅读时间: <!-- -->21<!-- -->分钟</span></p></header><footer><div class="meta flex flex-wrap"><div class="tags flex flex-wrap gap-px14"><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->BABEL<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->WEBPACK<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->ELEMENT-UI<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->TYPESCRIPT<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div></div></div></footer><main class="mt-px40"><div id="markdown"><p>最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。</p><h2 id="">方案</h2><p>这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。
总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow<strong>s</strong>erlist，更换了一些webpack的插件，主要有下：</p><blockquote><p> 移除的依赖</p></blockquote><pre><code class="lang-json">{
    &quot;babel-core&quot;: &quot;^6.26.3&quot;,
        &quot;babel-plugin-syntax-jsx&quot;: &quot;^6.18.0&quot;,  
  &quot;babel-plugin-transform-runtime&quot;: &quot;^6.22.0&quot;,
  &quot;babel-preset-latest&quot;: &quot;^6.22.0&quot;,  
&quot;babel-preset-stage-2&quot;: &quot;^6.22.0&quot;,  
&quot;babel-register&quot;: &quot;^6.26.0&quot;,  
&quot;babel-runtime&quot;: &quot;^6.23.0&quot;,
}</code></pre><blockquote><p>更新或新增的依赖</p></blockquote><pre><code class="lang-json">&quot;@babel/polyfill&quot;: &quot;^7.6.0&quot;,  
&quot;@babel/runtime&quot;: &quot;^7.6.3&quot;,
&quot;@babel/core&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-external-helpers&quot;: &quot;^7.2.0&quot;,  
&quot;@babel/plugin-proposal-class-properties&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-decorators&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-export-namespace-from&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-function-sent&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-json-strings&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-numeric-separator&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-proposal-throw-expressions&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-syntax-dynamic-import&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-syntax-import-meta&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-syntax-jsx&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/plugin-transform-runtime&quot;: &quot;^7.6.2&quot;,  
&quot;@babel/preset-env&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/preset-es2015&quot;: &quot;^7.0.0-beta.53&quot;,  
&quot;@babel/preset-typescript&quot;: &quot;^7.6.0&quot;,  
&quot;@babel/register&quot;: &quot;^7.0.0&quot;,  
&quot;@babel/runtime-corejs2&quot;: &quot;^7.0.0&quot;,
&quot;@vue/babel-plugin-transform-vue-jsx&quot;: &quot;^1.0.0&quot;,
&quot;babel-loader&quot;: &quot;^8.0.0&quot;,
&quot;clean-webpack-plugin&quot;: &quot;^3.0.0&quot;,
&quot;happypack&quot;: &quot;^5.0.1&quot;,  
&quot;html-webpack-include-assets-plugin&quot;: &quot;^2.0.0&quot;,
&quot;uglifyjs-webpack-plugin&quot;: &quot;^1.3.0&quot;,
&quot;webpack-bundle-analyzer&quot;: &quot;^2.13.1&quot;,
&quot;webpack-merge&quot;: &quot;^2.6.1&quot;,  
&quot;webpack-parallel-uglify-plugin&quot;: &quot;^1.1.2&quot;</code></pre><h2 id="">开工</h2><h3 id="happypack">happypack</h3><p>这里用的是<a href="https://github.com/amireh/happypack">happypack</a>开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。</p><blockquote><p>引入必要的依赖</p></blockquote><pre><code class="lang-javascript">const HappyPack = require(&#x27;happypack&#x27;) // 引用happypack
const os = require(&#x27;os&#x27;); // 获取系统配置
// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数
const happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length })</code></pre><p>然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的<strong>id=happyPack</strong>对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。</p><pre><code class="lang-javascript">// module.rules
{
    test: /\.js$/,
    // loader: &#x27;babel-loader&#x27;,  
    loader: &#x27;happypack/loader?id=happyPack&#x27;,
    include: [
      resolve(&#x27;src&#x27;),
      resolve(&#x27;test&#x27;),
     ],
    exclude: /node_modules/
},
// plugins
new HappyPack({  
  //用id来标识 happypack处理那里类文件  
  id: &#x27;happyPack&#x27;,  
  //如何处理  用法和loader 的配置一样  
  loaders: [{  
  loader: &#x27;babel-loader&#x27;,  
  // here you configure babel:  
  options: { babelrc: true, cacheDirectory: true }  
 }],  //共享进程池  
  threadPool: happyThreadPool,  
  //允许 HappyPack 输出日志  
  verbose: true,  
}),</code></pre><h3 id="dllplugin--dllreferenceplugin">DllPlugin 和 DllReferencePlugin</h3><p>Dllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。</p><p>首先我们先修改<code>/config/index.js</code>新增我们的dll配置方便引用，再在<code>/build</code>的目录下新增<code>webpack.dll.conf.js</code>用来打包dll。</p><blockquote><p>/config/index.js</p></blockquote><pre><code class="lang-javascript">// 新增配置
...
dll: {  
  static: path.resolve(__dirname, &#x27;../static/lib&#x27;),  // dll存放路径 相对于项目的static/lib
  list: {  // 多个包列表用来区分
      vendor: [&#x27;vue/dist/vue.common.js&#x27;,&#x27;vue-router&#x27;, &#x27;vuex&#x27;],  
      &#x27;asset&#x27;: [&#x27;superagent&#x27;]  
}</code></pre><blockquote><p>/build/webpack.dll.conf.js</p></blockquote><pre><code class="lang-javascript">var path = require(&#x27;path&#x27;)

var webpack = require(&#x27;webpack&#x27;)
var CleanWebpackPlugin = require(&#x27;clean-webpack-plugin&#x27;)

var config = require(&#x27;../config&#x27;)
var __root = path.resolve(__dirname, &#x27;../&#x27;)

module.exports = {
    context: __root, // 这里配置的context就是后面dll的context
    entry: config.dll.list,
    output: {
        path: config.dll.static,
        filename: &#x27;[name]-[chunkhash:7].dll.js&#x27;,
        library: &#x27;lib_[name]&#x27;,
        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。
        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***
        // libraryTarget: &#x27;umd&#x27;
    },
    resolve: {
        modules: [path.resolve(__root, &#x27;node_modules&#x27;)],
        extensions: [&#x27;.js&#x27;, &#x27;.json&#x27;],
        alias: {
            &#x27;vue$&#x27;: &#x27;vue/dist/vue.esm.js&#x27;
        }
    },
    // 这里没有写loaders，如果有需要可以自行添加loaders
    plugins: [
        // *** 这里很关键 ***
        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context
            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，
            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。
            path: path.resolve(__root, &#x27;static/manifest/[name].manifest.json&#x27;),
            name: &#x27;lib_[name]&#x27; // *** 这里的名字必须与output.library一致 ***
        }),
        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化
        new webpack.HashedModuleIdsPlugin(),
        new webpack.NamedChunksPlugin(),
    ]
}</code></pre><p>然后在<code>package.json</code>添加<code>&quot;build:dll&quot;: &quot;webpack --config build/webpack.dll.conf.js&quot;</code>用来生成dll，执行一下试试。</p><p><img alt="执行dll打包结果" src="https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png"/></p><p>在项目的<code>static/lib</code>的目录下会生成对应的dll.js, 而且在<code>static/manifest</code>目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。<strong>如果不手动上传，那么在服务器打包代码之前一定要执行一次<code>npm run build:dll</code>命令</strong></p><p>打包完dll之后，需要修改<code>webpack.base.js</code>让我们的在编译/打包的时候感受构建速度的提升。</p><blockquote><p>webpack.base.js</p></blockquote><pre><code class="lang-javascript">const HTMLWebpackIncludeAssetsPlugin = require(&#x27;html-webpack-include-assets-plugin&#x27;)  // 把我们的dll引入html
const CopyWebpackPlugin = require(&#x27;copy-webpack-plugin&#x27;) // 将dll文件拷贝到你的dist目录下
const __root = path.resolve(__dirname, &#x27;../&#x27;)
// 获取dll文件的manifest
function getDllManifest() {
    var plugins = []
    Object.keys(config.dll.list).forEach((name) =&gt; {
        plugins.push(
            new webpack.DllReferencePlugin({
                context: __root, // 这里的context必须与DllPlugin中的context保持一致
                manifest: path.resolve(__root, &#x27;static/manifest/[name].manifest.json&#x27;).replace(
                    /\[name\]/gi, name)
            })
        )
    })
    return plugins
}

//plugins

plugins: [
    //...
    ...getDllManifest(),
    new HTMLWebpackIncludeAssetsPlugin({
        append: false,
        publicPath: config.build.assetsPublicPath,
        assets: [{
            path: config.build.assetsSubDirectory,
            glob: &#x27;**/*.js&#x27;,
            globPath: config.dll.static
        }],
    }),
]</code></pre><p>这样DllPlugin 和 DllReferencePlugin的配置基本就完成了</p><h3 id="">其他构建的小优化和坑</h3><p>之前构建的时候会一直看到这样的错误: <code># DefaultsError: &#x27;warnings&#x27; is not a supported option</code>
是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的<a href="[https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin">uglifyjs-webpack-plugin</a>)插件代替webpack自带的。</p><p>修改如下:</p><pre><code class="lang-javascript">// new webpack.optimize.UglifyJsPlugin({  
//   compress: {  
//     warnings: false  
//   },  
//   sourceMap: true  
// }),
new UglifyJsPlugin({  
  cache: &#x27;.cache/&#x27;,  
  parallel: true,  
}),</code></pre><p>然后在dev环境中新增<a href="https://github.com/webpack-contrib/webpack-bundle-analyzer">BundleAnalyzerPlugin</a>用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化</p><h3 id="babe7">babe7升级</h3><p>升级到babel7非常简单，可以看<a href="https://babeljs.io/docs/en/v7-migration">官网升级指南</a>。
其实主要更新有以下几点：
  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?
  2. <a href="https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets">移除stage-*</a>
  3. 以下预设都归并到&quot;@babel/preset-env&quot;了
        -   <code>babel-preset-es2015</code>
        -   <code>babel-preset-es2016</code>
        -   <code>babel-preset-es2017</code>
        -   <code>babel-preset-latest</code>
        -  A combination of the above ^</p><p>所以这里展示一下升级后<code>.bablerc</code>，仅供参考~</p><blockquote><p>.bablerc</p></blockquote><pre><code class="lang-json">// {
//   &quot;presets&quot;: [
//     [&quot;latest&quot;, {
//       &quot;es2015&quot;: { &quot;modules&quot;: false }
//     }],
//     &quot;stage-2&quot;
//   ],
//   &quot;plugins&quot;: [&quot;transform-runtime&quot;, &quot;transform-vue-jsx&quot;],
//   &quot;comments&quot;: false,
//   &quot;env&quot;: {
//     &quot;test&quot;: {
//       &quot;presets&quot;: [&quot;latest&quot;, &quot;stage-2&quot;],
//       &quot;plugins&quot;: [ &quot;istanbul&quot; ]
//     }
//   }
// }

{  
  &quot;presets&quot;: [&quot;@babel/preset-env&quot;, &quot;@babel/preset-typescript&quot;, &quot;@vue/babel-preset-jsx&quot;],  
  &quot;plugins&quot;: [&quot;@babel/plugin-transform-runtime&quot;, &quot;@babel/plugin-external-helpers&quot;]  
}</code></pre><h2 id="">测试</h2><p>到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.</p><h3 id="mac-612">mac 6核12线程</h3><blockquote><p>更新前打包速度</p></blockquote><p><img alt="mac-更新前打包速度" src="https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png"/></p><blockquote><p>更新后打包速度</p></blockquote><p><img alt="mac-更新后打包速度" src="https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png"/></p><h3 id="centos-">centos 单核双线程</h3><blockquote><p>更新前打包速度</p></blockquote><p><img alt="centos-更新前打包速度" src="https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png"/></p><blockquote><p>更新后打包速度</p></blockquote><p><img alt="centos-更新后打包速度" src="https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png"/></p><p>可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。</p><h2 id="">总结</h2><p>总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能<strong>没有效果</strong>，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～</p></div></main></article><div class="line my-px60 w-full h-px dark:bg-primary"></div><div class="more flex flex-col"><div class="title flex h-px36 text-2xl items-center dark:text-white"><span class="font-light">更多阅读</span><div class="animate-arrow flex items-center ml-px20 w-px24 h-px12 relative transition-all"><div class="absolute left-0 w-full h-px" style="background-color:#fff"></div><div class="absolute border-solid border border-t-0 border-r border-b border-l-0 p-px4 right-0 transform -rotate-45" style="border-color:#fff"></div></div></div><div class="more-articles flex flex-wrap"><article class="article flex py-px60 border-b dark:border-primary lg:px-px20 items lg:w-1/2 xl:w-1/3 w-full"><div class="w-full"><header class="mb-2"><div class="date text-xs leading-5 dark:text-grayGreen">2021 / 02 / 05</div></header><main><h1 class="text-2xl leading-10/15 md:leading-10/15 font-bold dark:text-white mb-px24 cursor-pointer transition-all dark:hover:text-primary md:text-2xl">SSR项目规划</h1><div class="text-base desc dark:text-white dark:text-opacity-80 leading-6 mb-6">目前公司项目的类型多数是SPA,前端负责界面显示，后端负责数据存储和计算，各司其职，不会把前后端的逻辑混杂在一起，可以减轻服务器压力，服务器只用提供调用的接口，不用管展示逻辑和页面合成，吞吐能力会提高几倍；开发非常方便但是不可避免的有副作用...</div></main><footer><div class="meta flex flex-wrap"><div class="tags flex flex-wrap gap-px14"><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->SSR<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div></div></div></footer></div><div class="hidden"><div class="flex flex-col gap-y-px40"><div class="tag-info"><div class="flex items-center"><div class="w-px4 h-px4 dark:bg-primary mr-px8 rounded-full"></div>本文字数</div><div class="ml-px12">3910<!-- -->字</div></div><div class="tag-info"><div class="flex items-center"><div class="w-px4 h-px4 dark:bg-primary mr-px8 rounded-full"></div>阅读时间</div><div class="ml-px12">9<!-- -->分钟</div></div></div></div></article><article class="article flex py-px60 border-b dark:border-primary lg:px-px20 items lg:w-1/2 xl:w-1/3 w-full"><div class="w-full"><header class="mb-2"><div class="date text-xs leading-5 dark:text-grayGreen">2021 / 02 / 05</div></header><main><h1 class="text-2xl leading-10/15 md:leading-10/15 font-bold dark:text-white mb-px24 cursor-pointer transition-all dark:hover:text-primary md:text-2xl">markdown语法css调试</h1><div class="text-base desc dark:text-white dark:text-opacity-80 leading-6 mb-6">专门用来调试markdown的语法</div></main><footer><div class="meta flex flex-wrap"><div class="tags flex flex-wrap gap-px14"><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 top cursor-default dark:text-black dark:bg-primary">置顶</div><div class="flex items-center tag py-px2 px-px17 rounded-full text-sm transition-all h-px23 cursor-pointer dark:text-primary border border-primary border-opacity-50 dark:bg-opacity-10 dark:bg-primary hover:pr-px32"><span class="relative">#<!-- -->MARKDOWN<div class="absolute left-full animate-short-arrow ml-px4 w-0 transition-all overflow-hidden top-0"><iconpark-icon color="#7BF0BE" size="11" name="tag-right"></iconpark-icon></div></span></div></div></div></footer></div><div class="hidden"><div class="flex flex-col gap-y-px40"><div class="tag-info"><div class="flex items-center"><div class="w-px4 h-px4 dark:bg-primary mr-px8 rounded-full"></div>本文字数</div><div class="ml-px12">1534<!-- -->字</div></div><div class="tag-info"><div class="flex items-center"><div class="w-px4 h-px4 dark:bg-primary mr-px8 rounded-full"></div>阅读时间</div><div class="ml-px12">3<!-- -->分钟</div></div></div></div></article></div></div></main><footer class="dark:text-primary text-xs leading-5 my-px60 mx-5 md:mx-16">© 2021 Yangger.com 保留所有权利</footer></div></div></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"global":{"id":1,"siteName":"Yangger Blog","created_at":"2021-07-29T05:57:51.255Z","updated_at":"2021-07-29T07:30:01.657Z","defaultSeo":{"id":2,"metaTitle":"HomePage","metaDescription":"Yangger的博客","shareImage":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}},"favicon":{"id":4,"name":"favicon.png","alternativeText":null,"caption":null,"width":512,"height":512,"formats":{"thumbnail":{"name":"thumbnail_favicon.png","hash":"thumbnail_favicon_4d87055159","ext":".png","mime":"image/png","width":156,"height":156,"size":6.27,"path":null,"url":"/uploads/thumbnail_favicon_4d87055159.png"},"small":{"name":"small_favicon.png","hash":"small_favicon_4d87055159","ext":".png","mime":"image/png","width":500,"height":500,"size":28.98,"path":null,"url":"/uploads/small_favicon_4d87055159.png"}},"hash":"favicon_4d87055159","ext":".png","mime":"image/png","size":5.26,"url":"/uploads/favicon_4d87055159.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.548Z","updated_at":"2021-07-29T05:57:51.548Z"}},"articleInfo":{"count":5,"pageSize":1},"article":{"id":4,"title":"webpack2.6升级ts支持","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"0201-03-11T20:24:17.000Z","status":"published","slug":"webpack2-6-ts","author":{"id":3,"name":"Yangger","email":"i@yangger.cn","created_at":"2021-07-29T06:32:53.775Z","updated_at":"2021-07-29T06:32:53.783Z","picture":null},"articletype":null,"created_at":"2021-07-29T07:13:40.603Z","updated_at":"2021-07-29T09:00:21.859Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"},"categories":[{"id":6,"name":"BABEL","slug":"babel","created_at":"2021-07-29T07:07:57.200Z","updated_at":"2021-07-29T07:07:57.270Z"},{"id":7,"name":"WEBPACK","slug":"webpack","created_at":"2021-07-29T07:08:08.636Z","updated_at":"2021-07-29T07:08:08.642Z"},{"id":10,"name":"ELEMENT-UI","slug":"element-ui","created_at":"2021-07-29T07:12:04.629Z","updated_at":"2021-07-29T07:12:04.634Z"},{"id":11,"name":"TYPESCRIPT","slug":"typescript","created_at":"2021-07-29T07:12:14.521Z","updated_at":"2021-07-29T07:12:14.527Z"}],"nextItem":{"id":5,"title":"markdown语法css调试","description":"专门用来调试markdown的语法","content":"# 这是一级标题\n\n## 这是二级标题\n\n### 这是三级标题\n\n#### 这是四级标题\n\n##### 这是五级标题\n\n###### 这是六级标题\n\n## 字体\n\n**这是加粗的文字**\n\n*这是倾斜的文字*`\n\n***这是斜体加粗的文字***\n\n~~这是加删除线的文字~~\n\n## 引用\n\n\u003e 这是引用的内容\n\n\u003e\u003e 这是引用的内容\n\n\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e 这是引用的内容\n\n## 分割线\n\n### 分割线---\n\n--- \n\n### 分割线 ***\n\n***\n\n## 图片\n\n![blockchain](https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=702257389,1274025419\u0026fm=27\u0026gp=0.jpg \"区块链\")\n\n## 超链接\n\n[简书](http://jianshu.com)\n[百度](http://baidu.com)\n\n## 列表\n\n### 无序列表\n\n- 列表内容\n+ 列表内容\n* 列表内容\n\n### 有序列表\n\n1. 列表内容\n2. 列表内容\n3. 列表内容\n\n### 列表嵌套\n\n1. 苹果\n   1. 苹果6 \n   2. 苹果7 \n2. 安卓\n3. 哈哈\n\n- 测试\n   - 测试1\n   - 测试2\n- 笔记\n\n## 表格\n\n姓名|技能|排行\n--|:--:|--:\n刘备|哭|大哥\n关羽|打|二哥\n张飞|骂|三弟\n\n## 代码\n\n`代码`\n\n```css\narticle #markdown {}\narticle #markdown h1,\narticle #markdown h2,\narticle #markdown h3,\narticle #markdown h4,\narticle #markdown h5,\narticle #markdown h6 {\n    font-family: Inter;\n    font-style: normal;\n    font-weight: bold;\n    line-height: 1.5;\n    margin: 10px 0;\n}\narticle #markdown h1 {\n    font-size: 2.25rem;\n}\narticle #markdown h2 {\n    font-size: 1.625rem;\n}\n\narticle #markdown h3 {\n    font-size: 1.25rem;\n}\n\narticle #markdown h4,\narticle #markdown h5,\narticle #markdown h6 {\n    font-size: 1rem;\n}\n\n```\n\n## 正文\n\n这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字\n\n","publishedAt":"2021-08-02T04:00:00.000Z","status":"published","slug":"markdown-css","author":{"id":3,"name":"Yangger","email":"i@yangger.cn","created_by":1,"updated_by":1,"created_at":"2021-07-29T06:32:53.775Z","updated_at":"2021-07-29T06:32:53.783Z","picture":null},"articletype":"Items","created_by":{"id":1,"firstname":"Yang","lastname":"ger","username":null,"email":"i@yangger.cn","password":"$2a$10$dC6wYtNCnHR.qjKkUCuucu47yeFXYT1XzIA4KnNv.lJQs6e3QIWeC","resetPasswordToken":null,"registrationToken":null,"isActive":true,"blocked":null,"preferedLanguage":null},"updated_by":{"id":1,"firstname":"Yang","lastname":"ger","username":null,"email":"i@yangger.cn","password":"$2a$10$dC6wYtNCnHR.qjKkUCuucu47yeFXYT1XzIA4KnNv.lJQs6e3QIWeC","resetPasswordToken":null,"registrationToken":null,"isActive":true,"blocked":null,"preferedLanguage":null},"created_at":"2021-08-02T08:44:15.613Z","updated_at":"2021-08-03T07:46:26.856Z","top":true,"image":{"id":4,"name":"favicon.png","alternativeText":null,"caption":null,"width":512,"height":512,"formats":{"thumbnail":{"name":"thumbnail_favicon.png","hash":"thumbnail_favicon_4d87055159","ext":".png","mime":"image/png","width":156,"height":156,"size":6.27,"path":null,"url":"/uploads/thumbnail_favicon_4d87055159.png"},"small":{"name":"small_favicon.png","hash":"small_favicon_4d87055159","ext":".png","mime":"image/png","width":500,"height":500,"size":28.98,"path":null,"url":"/uploads/small_favicon_4d87055159.png"}},"hash":"favicon_4d87055159","ext":".png","mime":"image/png","size":5.26,"url":"/uploads/favicon_4d87055159.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_by":null,"updated_by":null,"created_at":"2021-07-29T05:57:51.548Z","updated_at":"2021-07-29T05:57:51.548Z"},"categories":[{"id":12,"name":"MARKDOWN","slug":"markdown","created_by":1,"updated_by":1,"created_at":"2021-08-02T08:43:49.809Z","updated_at":"2021-08-02T08:43:49.820Z"}]},"prevItem":{"id":1,"title":"SSR项目规划","description":"目前公司项目的类型多数是SPA,前端负责界面显示，后端负责数据存储和计算，各司其职，不会把前后端的逻辑混杂在一起，可以减轻服务器压力，服务器只用提供调用的接口，不用管展示逻辑和页面合成，吞吐能力会提高几倍；开发非常方便但是不可避免的有副作用...","content":"目前公司项目的类型多数是SPA,前端负责界面显示，后端负责数据存储和计算，各司其职，不会把前后端的逻辑混杂在一起，可以减轻服务器压力，服务器只用提供调用的接口，不用管展示逻辑和页面合成，吞吐能力会提高几倍；开发非常方便但是不可避免的有副作用：\n\n* 首屏加载速度慢\n* SEO 支持缺失\n\n所以现在准备规划一种方案可以兼顾SPA和服务器渲染的优势\n\n## SSR 介绍\n\nSSR(Server Side Rendering)刚好弥补了SPA的不足，使得前后端分离真正可以达到和传统网站的效果并超越传统网站。\n关于前后端分离或SPA的优点可以自行了解，SSR相对于SPA主要有以下提升\n\n### 更快的首屏展示速度\n\n由于 SPA 需要先加载完 JavaScript 脚本才能开始渲染，所以首屏渲染并不快，在 JavaScript 加载中只能显示简单的等待画面。\nSSR 是服务端渲染，可以直接输出 HTML 内容，在首屏展示上更有优势。\n\n### SEO 支持\n\nSEO 的重要性大家都知道，因为 SEO 需求导致 SPA 对电商，首页，内容类网站等需要 SEO 的页面望而却步，只能回到传统服务端渲染的方案中。\nSSR 弥补了 SEO 的不足，真正的可以通过前后端分离的方式完成此类网站。\n\n## 框架选型\n\nSSR目前分Client(客户端)和Server(服务端),以及可能配合PWA，**主要**使用的是以下:\n\n### Client\n\n* Vue,Vuex,Vue-Router (Vue全家桶)\n* Vue-Meta(完善SEO配置)\n* Nuxt(SSR UI渲染，同时抽象出客户端/服务器分布。)\n\n### Server\n\n* koa (Nodejs 下一代的Web框架)\n* logger (日志)\n* Routing-controllers (使用方法创建控制器类作为处理请求的操作,将路由控制器与koa一起使用)\n* Sequelize (Sequelize是MySQL的基于承诺的Node.js ORM框架。它具有可靠的事务支持，关系，读取复制等功能。)\n* Redis (缓存)\n\n### PWA (Progressive Web Apps)\n\n* Workbox (Google 开发的工具集，能够方便地集成到 Webpack、Gulp 等构建流程中，帮助开发者生成或者注入部分 ServiceWorker 相关代码)\n* Service Worker (服务工作线程, 浏览器后台独立于网页的脚本，预缓存，消息推送，后台同步)\n* App Shell模型 (加载必要界面, 进行离线缓存)\n\n## 目标效果\n\n* 直接访问页面达到传统服务器渲染的速度\n* 项目内跳转像 SPA 一样快速跳转\n* 支持 SEO\n* 同构代码，节省开发工作量，提升效率\n* 前后端分离，可并行开发，独立管理\n\n## 核心思路\n\n* 输入地址访问或刷新访问时在 Clinet 端渲染页面\n* 浏览器中跳转时在 Server 端渲染页面\n* 前后端公用同一套业务代码\n* 利用中间件，适配器以及环境判断屏蔽掉业务代码中的环境差异\n\n## 目录结构\n\n```\n├─client\n│  ├─.nuxt\n│  │  ├─components\n│  │  └─views\n│  ├─assets\n│  │  ├─icon\n│  │  └─less\n│  ├─biz-components\n│  ├─components\n│  ├─layouts\n│  ├─middleware\n│  ├─pages\n│  ├─plugins\n│  ├─service\n│  ├─static\n│  │  └─base\n│  ├─store\n│  │  └─modules\n│  └─utils\n├─server\n│   ├─controllers\n│   │  └─api\n│   ├─interfaces\n│   ├─middlewares\n│   └─utils\n├─.editorconfig\n├─.eslintignore\n├─.eslintrc.js\n├─index.js\n├─nuxt.config.js\n├─package.json\n├─package-lock.json\n├─README.md\n├─tsconfig.json\n├─tslint.json\n└─yarn.lock\n```\n## 总体规划\n\n使用Nuxt和PWA配合Koa完成SSR，利于SEO优化和首屏渲染时间加速.但是也有局限性存在:\n* 服务端压力较大: 在高并发的访问下，服务端大量占用服务器的资源\n* 开发条件受限: created和beforeCreate之外的生命周期钩子不可用，因此项目引用的第三方的库也不可用其它生命周期钩子，这对引用库的选择产生了很大的限制；\n* 学习成本相对较高: 除了对webpack、Vue要熟悉，还需要掌握node、Koa相关技术。相对于客户端渲染，项目构建、部署过程更加复杂。\n\n示意图\n\n![build示意图](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftb2l9t44nj31gn0rt42r.jpg)\n\n###客戶端规划\n\n在VUE的項目中,同一套代码在 Node 端和浏览器端都能运行，是没有“后端模板”的概念的，同样对于“内容片段”也是如此。在首屏使用服务端渲染直出 HTML 后，浏览器端进行 Hydrate(混合)，绑定事件使页面真正可响应，除非刷新页面，否则后续的路由切换都将由前端路由器完成。\n在 Vue SSR 项目中的实际效果就是首屏由服务端渲染，随后当路由切换时，客户端会请求对应的路由组件代码。所以***前端路由向服务端请求内容片段渲染内容***实际上已经完成了，对于开发者并没有额外的工作要做。\n\n* 引用***Nuxt*** 可选引用***PWA***\n* 预缓存 App Shell 页面\n* Service Worker 拦截所有 HTML 请求，统一返回缓存的 App Shell 页面。同时向服务端请求当前页面需要的内容片段并写入缓存\n* 前端路由( app.js )向服务端请求内容片段，发现缓存中已存在，将其填充进 App Shell 中，完成前端渲染\n* 离线用户体验(选用)\n\n![SSR](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftb1edsgakj30k00bg77l.jpg)\n\n### 服務端规划\n\n这里的服务端是指Nuxt和渲染客户端使用的，因为公司用的后端是Java，所以这里的Node作为中间层使用，并且完成前端使用SSR，页面缓存也可以帮助前端调整一下后端的数据，或者写接口，拓展性非常强。\n\n* 支持返回完整页面和内容片段( contentOnly )\n* 渲染Nuxt生成的UI\n* 页面缓存\n\nSSR需要先在服务器端生成虚拟 DOM ，然后再序列化为 HTML 文本，而且为了请求之间的隔离性，每次请求都会创建一个新的 context ，这种做法使得它与直接使用模板引擎相比性能差了数十倍。  \n所以为了提高并发，并且为了降低服务器的性能损耗，所以需要要针对常用界面或者特定组件做长时间的缓存,这里用Redis做缓存,流程图如下\n\n![服务端渲染时序图-命中缓存](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftbg8mcmi8j30m80cial3.jpg)\n\n![服务端渲染时序图-未命中缓存](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftbg8vhvzoj30m80cik36.jpg)\n\n### 服務器规划\n\n* cdn缓存策略\n* nginx缓存策略\n\n## 参考资料\n\n[App Shell 模型](https://developers.google.cn/web/fundamentals/architecture/app-shell)  \n[offline](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/)  \n[workbox](https://developers.google.com/web/tools/workbox/)  \n[在 Vue SSR 中使用 Service Worker](https://zhuanlan.zhihu.com/p/31630322)  \n[SSR 架构项目实现离线可用](https://zhuanlan.zhihu.com/p/30791448)  \n[VUE SSR定制与使用心得](https://zhuanlan.zhihu.com/p/36017189)  \n[解密Vue SSR](https://zhuanlan.zhihu.com/p/35871344)\n\n## 总结\n\n目前可用Nuxt,vue-meta配合Koa实现SEO和首屏渲染的时间.\n如果剥离Vue全家桶实现SSR且与PWA的Workbox实现更好的优化和用户体验，以及程序良好的性能，需要较高的开发成本且对开发人员有较高的需求\n***SSR与PWA的配合使用，实际运作生产环境开发难度较高, CPU 是 SSR 的性能瓶颈***\n","publishedAt":"0201-03-11T19:04:17.000Z","status":"published","slug":"ssr-project-plan","author":{"id":3,"name":"Yangger","email":"i@yangger.cn","created_by":1,"updated_by":1,"created_at":"2021-07-29T06:32:53.775Z","updated_at":"2021-07-29T06:32:53.783Z","picture":null},"articletype":"Banner","created_by":{"id":1,"firstname":"Yang","lastname":"ger","username":null,"email":"i@yangger.cn","password":"$2a$10$dC6wYtNCnHR.qjKkUCuucu47yeFXYT1XzIA4KnNv.lJQs6e3QIWeC","resetPasswordToken":null,"registrationToken":null,"isActive":true,"blocked":null,"preferedLanguage":null},"updated_by":{"id":1,"firstname":"Yang","lastname":"ger","username":null,"email":"i@yangger.cn","password":"$2a$10$dC6wYtNCnHR.qjKkUCuucu47yeFXYT1XzIA4KnNv.lJQs6e3QIWeC","resetPasswordToken":null,"registrationToken":null,"isActive":true,"blocked":null,"preferedLanguage":null},"created_at":"2021-07-29T07:01:17.931Z","updated_at":"2021-08-03T07:46:21.306Z","top":false,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_by":null,"updated_by":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"},"categories":[{"id":9,"name":"SSR","slug":"ssr","created_by":1,"updated_by":1,"created_at":"2021-07-29T07:08:21.486Z","updated_at":"2021-07-29T07:08:21.492Z"}]}},"categories":[{"id":6,"name":"BABEL","slug":"babel","created_at":"2021-07-29T07:07:57.200Z","updated_at":"2021-07-29T07:07:57.270Z","articles":[{"id":3,"title":"webpack2.x构建速度优化","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"2019-03-11T19:00:00.000Z","status":"published","slug":"webpack2-x","author":null,"articletype":null,"created_at":"2021-07-29T07:09:49.741Z","updated_at":"2021-07-29T09:00:31.546Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}},{"id":4,"title":"webpack2.6升级ts支持","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"0201-03-11T20:24:17.000Z","status":"published","slug":"webpack2-6-ts","author":3,"articletype":null,"created_at":"2021-07-29T07:13:40.603Z","updated_at":"2021-07-29T09:00:21.859Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":7,"name":"WEBPACK","slug":"webpack","created_at":"2021-07-29T07:08:08.636Z","updated_at":"2021-07-29T07:08:08.642Z","articles":[{"id":3,"title":"webpack2.x构建速度优化","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"2019-03-11T19:00:00.000Z","status":"published","slug":"webpack2-x","author":null,"articletype":null,"created_at":"2021-07-29T07:09:49.741Z","updated_at":"2021-07-29T09:00:31.546Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}},{"id":4,"title":"webpack2.6升级ts支持","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"0201-03-11T20:24:17.000Z","status":"published","slug":"webpack2-6-ts","author":3,"articletype":null,"created_at":"2021-07-29T07:13:40.603Z","updated_at":"2021-07-29T09:00:21.859Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":8,"name":"NGINX","slug":"nginx","created_at":"2021-07-29T07:08:15.693Z","updated_at":"2021-07-29T07:08:15.697Z","articles":[{"id":2,"title":"nginx本地配置","description":"在平时开发过程中，一般都是用webpack+http-proxy完成对后端接口的调用，公司的微服务有很多，很多时候再调试的时候需要切换配置文件或者修改配置文件来调试接口，但是由于公司老项目体积太大，所以每次修改配置重启服务的时间都可以泡一杯☕️~","content":"\u003e  在平时开发过程中，一般都是用[webpack]([https://webpack.js.org/](https://webpack.js.org/))+http-proxy完成对后端接口的调用，公司的微服务有很多，很多时候再调试的时候需要切换配置文件或者修改配置文件来调试接口，但是由于公司老项目体积太大，所以每次修改配置重启服务的时间都可以泡一杯☕️~\n\n## 想法\n\n这里想的是用[Electron]([http://electronjs.org/](http://electronjs.org/)) + Vue2.x做的客户端，通过nginx来代理本地的某个端口到服务器，用\bnode的child_process，修改nginx.conf配置文件来启动、重启、重载nginx服务本地nginx服务。\n\n## 开工\n\n### [NginxService.js](https://github.com/yangger6/electron-nginx/blob/master/src/main/NginxService.js) 用来管理nginx服务\n\n首先是要区分windows还是 mac os，这里暂时没有考虑Linux，其实是因为懒zzzz。\n区分是不是windows\n\n```javascript\nconst isWindows = process.platform === 'win32'\n```\n\n然后获取nginx的配置文件 **(配置文件为了方便导入导出和配置，是通过读取json文件用ejs生产最终的nginx.conf)** 。\n\n\u003e nginx配置的模板文件conf.ejs\n\n```\nworker_processes  1;  \n  \nerror_log  \"\u003c%=logPath%\u003e\";  \nerror_log  \"\u003c%=logPath%\u003e\"  notice;  \nerror_log  \"\u003c%=logPath%\u003e\"  info;  \n  \nevents {  \n    worker_connections  1024;  \n}  \nhttp {  \n    include       mime.types;  \n    client_body_temp_path \"\u003c%=tempPath%\u003e/client_body_temp\";  \n    proxy_temp_path \"\u003c%=tempPath%\u003e/proxy_temp\";  \n    fastcgi_temp_path \"\u003c%=tempPath%\u003e/fastcgi_temp\";  \n    default_type  application/octet-stream;  \n    #log_format  main  '$remote_addr - $remote_user [$time_local] \"$request\" '  \n    #                  '$status $body_bytes_sent \"$http_referer\" '  \n    #                  '\"$http_user_agent\" \"$http_x_forwarded_for\"';  \n    #access_log  logs/access.log  main;  \n    sendfile        on;  \n    #tcp_nopush     on;  \n    #keepalive_timeout  0;  \n    keepalive_timeout  65;  \n    #gzip  on;  \n    server {  \n        listen       \u003c%=port%\u003e;  \n        server_name  127.0.0.1;  \n        error_page   500 502 503 504  /50x.html;  \n        location = /50x.html {  \n            root   html;  \n        }  \n        location / {  \n            proxy_pass \u003c%=defaultMode%\u003e;  \n        }\u003c% rules.map(rule =\u003e {%\u003e  \n  location \u003c%=rule.path%\u003e {  \n            proxy_pass \u003c%=rule.proxy%\u003e;  \n        }\u003c% }) %\u003e  \n  }  \n}\n```\n\n\u003e 配置json文件\n\n```json\n{  \n  \"mode\": \"boss-test\", // 当前环境  \n  \"port\": \"8890\", // 代理端口 需要跟前端的代理地址一致  \n  \"host\": {  \n\t  \"boss-test\": \"https://test.www.xxxx.com.cn\", // 个个环境的代理地址  \n\t  \"boss-dev\": \"https://dev.www.xxxx.com.cn\",  \n\t  \"boss-pro\": \"https://xxxxx.xxxx.com\",  \n\t  \"m.xxxx\": \"https://test.m.xxxx.com.cn\",  \n  },  \n \"proxyRules\": [ // 针对单独的特定接口的环境代理，例如我在测试环境需要调用一个开发环境的端口  \n\t  {  \n\t  \"id\": \"06eb1141-44e6-423e-bb83-c6cff5b9cc86\",  \n\t  \"mode\": \"boss-pro\", // 单独接口的环境  \n\t  \"rule\": \"/boss-api\", // 代理规则  \n\t  \"status\": false // 是否是用配置  \n\t  }\n\t]\n}\n```\n\n因为linux和windos的路径问题，读取配置需要注意反斜杠和斜杠的转译，所以处理的代码如下\n\n```javascript\nif (isWindows) {  \n  const truePath = path.resolve(path.join(__static, `./nginx/windows/`))  \n  this.nginx = '\"' + truePath + '/nginx.exe\" ' + '-p \"' + truePath + '\"'  \n  this.nginx = this.nginx.replace(/\\\\/g, '/')  \n} else {  \n  this.nginx = path.resolve(path.join(__static, `./nginx/mac/bin/nginx`))  \n}\n```\n\n然后就是启动nginx服务了,通过用[child_process.exec](https://nodejs.org/api/child_process.html#child_process_child_process_exec_command_options_callback)启动子进程，因为用electron打包之后是看不到文件的，所以这里要添加日志记录每一步的操作，为了以后方便排错, 重启和重载服务很简单，这里贴出代码不一一讲解。\n\n```javascript\nasync start () {  \n  try {  \n  let config = this.config  // 获取执行路径\n  if (isWindows) {  \n  config = `\"${config}\"`  // windows 的特殊处理- -\n  }  \n  const {stderr} = await exec(`${this.nginx} -c ${config}`)  // 启动\n  console.log(stderr)  \n  await addLog('nginx start successful')  // 记录日志\n  return true  \n  } catch (e) {  \n  await addLog('nginx start error -\u003e' + e)  \n  console.log(e)  \n  return false  \n  }  \n}\nasync stop () {  \n  try {  \n  if (isWindows) {  \n  await exec(`taskkill /fi \"imagename eq nginx.EXE\" /f`)  \n } else {  \n  await exec(`ps -lef|grep -i nginx:|awk '{ print $2}'|xargs kill -9`)  \n } } catch (e) {  \n  await addLog('nginx stop error -\u003e' + e)  \n  console.log(e)  \n }  await addLog('nginx stop successful')  \n  return true  \n}\nasync reload () {  \n  try {  \n  if (await this.test()) {  \n  if (isWindows) {  \n  const {stdout, stderr} = await exec(`${this.nginx} -s reload -c \"${this.config}\"`)  \n  console.log(stdout)  \n  console.log(stderr)  \n } else {  \n  const {stdout, stderr} = await exec(`${this.nginx} -s reload`)  \n  console.log(stdout)  \n  console.log(stderr)  \n }  await addLog('nginx reload successful')  \n  return true  \n  } else {  \n  return false  \n  }  \n } catch (e) {  \n  await addLog('nginx reload error -\u003e' + e)  \n  console.log(e)  \n  return false  \n  }  \n}\n```\n\n这里要讲一下，这里是通过用命令检测配置nginx的端口有没有被占用来看nginx的状态(没想到更好的方案)，如果有更好的办法，欢迎在评论区指出^^\n\n```javascript\nasync status () {  \n  try {  \n  const jsonObj = JSON.parse(fs.readFileSync(jsonPath, 'utf8'))  \n  if (isWindows) {  \n  await exec(`netstat -ano|findstr ${jsonObj.port}`)  \n } else {  \n  await exec(`lsof -i:${jsonObj.port}`)  \n }  await addLog('nginx get status successful')  \n  return true  \n  } catch (e) {  \n  await addLog('nginx get status error -\u003e' + e)  \n  console.log(e)  \n  return false  \n  }  \n}\n```\n\n### main.js 引入NginxService, 与渲染进程通信\n\n这里直接放出代码，主要用的是electron的(ipcMain)[[https://electronjs.org/docs/api/ipc-main#ipcmain](https://electronjs.org/docs/api/ipc-main#ipcmain)]来从主进程到渲染进程的异步通信。\n\n\u003e listen.js\n\n```javascript\nimport nginxService from './NginxService'  \nimport path from 'path'  \nimport fs from 'fs'  \nimport {renderConfig, changeMode, updatePort, deleteMode, addHost, addRules, deleteRule, updateRule, importFile, cleanLogs} from './nginx/index'  \nconst jsonPath = path.resolve(path.join(__static, './nginx/config/proxy.json'))  \nconst { ipcMain } = require('electron')  \nipcMain.on('get-rules', async (event, arg) =\u003e {  \n  event.returnValue = JSON.parse(fs.readFileSync(jsonPath, 'utf8'))  \n})  \nipcMain.on('get-path', async (event) =\u003e {  \n  event.returnValue = path.resolve(path.join(__static, './nginx/config/proxy.json'))  \n})  \nipcMain.on('get-error-log-path', async (event) =\u003e {  \n  event.returnValue = path.resolve(path.join(__static, `./nginx/${process.platform === 'win32' ? 'windows' : 'mac'}/logs/error.log`))  \n})  \nipcMain.on('get-logs', async (event) =\u003e {  \n  event.returnValue = fs.readFileSync(path.resolve(path.join(__static, `./log.txt`)), 'utf8')  \n})  \nipcMain.on('get-logs-path', async (event) =\u003e {  \n  event.returnValue = path.resolve(path.join(__static, `./log.txt`))  \n})  \nipcMain.on('clean-logs', async (event) =\u003e {  \n  event.returnValue = await cleanLogs()  \n})  \nipcMain.on('get-status', async (event, arg) =\u003e {  \n  event.returnValue = await nginxService.status()  \n})  \nipcMain.on('stop-nginx', async (event, arg) =\u003e {  \n  event.returnValue = await nginxService.stop()  \n})  \nipcMain.on('start-nginx', async (event, arg) =\u003e {  \n  nginxService.start()  \n  setTimeout(() =\u003e {  \n  event.returnValue = true  \n  }, 1000)  \n})  \nipcMain.on('render-config', async (event, arg) =\u003e {  \n  event.returnValue = await renderConfig()  \n})  \nipcMain.on('reload-nginx', async (event, arg) =\u003e {  \n  event.returnValue = await nginxService.reload()  \n})  \nipcMain.on('add-host', async (event, arg) =\u003e {  \n  event.returnValue = await addHost(...arg)  \n})  \nipcMain.on('add-rule', async (event, arg) =\u003e {  \n  event.returnValue = await addRules(...arg)  \n})  \nipcMain.on('delete-rule', async (event, arg) =\u003e {  \n  event.returnValue = await deleteRule(arg)  \n})  \nipcMain.on('update-rule', async (event, arg) =\u003e {  \n  event.returnValue = await updateRule(...arg)  \n})  \nipcMain.on('update-mode', async (event, arg) =\u003e {  \n  event.returnValue = await changeMode(arg)  \n})  \nipcMain.on('delete-mode', async (event, arg) =\u003e {  \n  event.returnValue = await deleteMode(arg)  \n})  \nipcMain.on('update-port', async (event, arg) =\u003e {  \n  event.returnValue = await updatePort(arg)  \n})  \nipcMain.on('import-file', async (event, arg) =\u003e {  \n  event.returnValue = await importFile(arg)  \n})\n```\n\n再从main.js引入listen.js即可\n\n```javascript\n// 监听render事件    \nrequire('./linten')\n```\n\n### 渲染进程代码\n\n主要就是用vue+element-ui写的界面再与主进程通信调用nginx的服务，这里就不贴出来了，可以到[项目地址](https://github.com/yangger6/electron-nginx)查看。\n\n## 总结\n\n总的来说，这个东西难度不大，但是很省事，比较不是谁都能忍受每次重启项目要等5-6分钟，也得找个时间优化一下老项目了，历史遗留问题太多了zzzz.","publishedAt":"0201-03-11T19:24:17.000Z","status":"published","slug":"nginx-local-setting","author":3,"articletype":null,"created_at":"2021-07-29T07:06:15.607Z","updated_at":"2021-07-29T09:00:06.492Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":9,"name":"SSR","slug":"ssr","created_at":"2021-07-29T07:08:21.486Z","updated_at":"2021-07-29T07:08:21.492Z","articles":[{"id":1,"title":"SSR项目规划","description":"目前公司项目的类型多数是SPA,前端负责界面显示，后端负责数据存储和计算，各司其职，不会把前后端的逻辑混杂在一起，可以减轻服务器压力，服务器只用提供调用的接口，不用管展示逻辑和页面合成，吞吐能力会提高几倍；开发非常方便但是不可避免的有副作用...","content":"目前公司项目的类型多数是SPA,前端负责界面显示，后端负责数据存储和计算，各司其职，不会把前后端的逻辑混杂在一起，可以减轻服务器压力，服务器只用提供调用的接口，不用管展示逻辑和页面合成，吞吐能力会提高几倍；开发非常方便但是不可避免的有副作用：\n\n* 首屏加载速度慢\n* SEO 支持缺失\n\n所以现在准备规划一种方案可以兼顾SPA和服务器渲染的优势\n\n## SSR 介绍\n\nSSR(Server Side Rendering)刚好弥补了SPA的不足，使得前后端分离真正可以达到和传统网站的效果并超越传统网站。\n关于前后端分离或SPA的优点可以自行了解，SSR相对于SPA主要有以下提升\n\n### 更快的首屏展示速度\n\n由于 SPA 需要先加载完 JavaScript 脚本才能开始渲染，所以首屏渲染并不快，在 JavaScript 加载中只能显示简单的等待画面。\nSSR 是服务端渲染，可以直接输出 HTML 内容，在首屏展示上更有优势。\n\n### SEO 支持\n\nSEO 的重要性大家都知道，因为 SEO 需求导致 SPA 对电商，首页，内容类网站等需要 SEO 的页面望而却步，只能回到传统服务端渲染的方案中。\nSSR 弥补了 SEO 的不足，真正的可以通过前后端分离的方式完成此类网站。\n\n## 框架选型\n\nSSR目前分Client(客户端)和Server(服务端),以及可能配合PWA，**主要**使用的是以下:\n\n### Client\n\n* Vue,Vuex,Vue-Router (Vue全家桶)\n* Vue-Meta(完善SEO配置)\n* Nuxt(SSR UI渲染，同时抽象出客户端/服务器分布。)\n\n### Server\n\n* koa (Nodejs 下一代的Web框架)\n* logger (日志)\n* Routing-controllers (使用方法创建控制器类作为处理请求的操作,将路由控制器与koa一起使用)\n* Sequelize (Sequelize是MySQL的基于承诺的Node.js ORM框架。它具有可靠的事务支持，关系，读取复制等功能。)\n* Redis (缓存)\n\n### PWA (Progressive Web Apps)\n\n* Workbox (Google 开发的工具集，能够方便地集成到 Webpack、Gulp 等构建流程中，帮助开发者生成或者注入部分 ServiceWorker 相关代码)\n* Service Worker (服务工作线程, 浏览器后台独立于网页的脚本，预缓存，消息推送，后台同步)\n* App Shell模型 (加载必要界面, 进行离线缓存)\n\n## 目标效果\n\n* 直接访问页面达到传统服务器渲染的速度\n* 项目内跳转像 SPA 一样快速跳转\n* 支持 SEO\n* 同构代码，节省开发工作量，提升效率\n* 前后端分离，可并行开发，独立管理\n\n## 核心思路\n\n* 输入地址访问或刷新访问时在 Clinet 端渲染页面\n* 浏览器中跳转时在 Server 端渲染页面\n* 前后端公用同一套业务代码\n* 利用中间件，适配器以及环境判断屏蔽掉业务代码中的环境差异\n\n## 目录结构\n\n```\n├─client\n│  ├─.nuxt\n│  │  ├─components\n│  │  └─views\n│  ├─assets\n│  │  ├─icon\n│  │  └─less\n│  ├─biz-components\n│  ├─components\n│  ├─layouts\n│  ├─middleware\n│  ├─pages\n│  ├─plugins\n│  ├─service\n│  ├─static\n│  │  └─base\n│  ├─store\n│  │  └─modules\n│  └─utils\n├─server\n│   ├─controllers\n│   │  └─api\n│   ├─interfaces\n│   ├─middlewares\n│   └─utils\n├─.editorconfig\n├─.eslintignore\n├─.eslintrc.js\n├─index.js\n├─nuxt.config.js\n├─package.json\n├─package-lock.json\n├─README.md\n├─tsconfig.json\n├─tslint.json\n└─yarn.lock\n```\n## 总体规划\n\n使用Nuxt和PWA配合Koa完成SSR，利于SEO优化和首屏渲染时间加速.但是也有局限性存在:\n* 服务端压力较大: 在高并发的访问下，服务端大量占用服务器的资源\n* 开发条件受限: created和beforeCreate之外的生命周期钩子不可用，因此项目引用的第三方的库也不可用其它生命周期钩子，这对引用库的选择产生了很大的限制；\n* 学习成本相对较高: 除了对webpack、Vue要熟悉，还需要掌握node、Koa相关技术。相对于客户端渲染，项目构建、部署过程更加复杂。\n\n示意图\n\n![build示意图](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftb2l9t44nj31gn0rt42r.jpg)\n\n###客戶端规划\n\n在VUE的項目中,同一套代码在 Node 端和浏览器端都能运行，是没有“后端模板”的概念的，同样对于“内容片段”也是如此。在首屏使用服务端渲染直出 HTML 后，浏览器端进行 Hydrate(混合)，绑定事件使页面真正可响应，除非刷新页面，否则后续的路由切换都将由前端路由器完成。\n在 Vue SSR 项目中的实际效果就是首屏由服务端渲染，随后当路由切换时，客户端会请求对应的路由组件代码。所以***前端路由向服务端请求内容片段渲染内容***实际上已经完成了，对于开发者并没有额外的工作要做。\n\n* 引用***Nuxt*** 可选引用***PWA***\n* 预缓存 App Shell 页面\n* Service Worker 拦截所有 HTML 请求，统一返回缓存的 App Shell 页面。同时向服务端请求当前页面需要的内容片段并写入缓存\n* 前端路由( app.js )向服务端请求内容片段，发现缓存中已存在，将其填充进 App Shell 中，完成前端渲染\n* 离线用户体验(选用)\n\n![SSR](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftb1edsgakj30k00bg77l.jpg)\n\n### 服務端规划\n\n这里的服务端是指Nuxt和渲染客户端使用的，因为公司用的后端是Java，所以这里的Node作为中间层使用，并且完成前端使用SSR，页面缓存也可以帮助前端调整一下后端的数据，或者写接口，拓展性非常强。\n\n* 支持返回完整页面和内容片段( contentOnly )\n* 渲染Nuxt生成的UI\n* 页面缓存\n\nSSR需要先在服务器端生成虚拟 DOM ，然后再序列化为 HTML 文本，而且为了请求之间的隔离性，每次请求都会创建一个新的 context ，这种做法使得它与直接使用模板引擎相比性能差了数十倍。  \n所以为了提高并发，并且为了降低服务器的性能损耗，所以需要要针对常用界面或者特定组件做长时间的缓存,这里用Redis做缓存,流程图如下\n\n![服务端渲染时序图-命中缓存](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftbg8mcmi8j30m80cial3.jpg)\n\n![服务端渲染时序图-未命中缓存](http://ww1.sinaimg.cn/large/005Yb8FKgy1ftbg8vhvzoj30m80cik36.jpg)\n\n### 服務器规划\n\n* cdn缓存策略\n* nginx缓存策略\n\n## 参考资料\n\n[App Shell 模型](https://developers.google.cn/web/fundamentals/architecture/app-shell)  \n[offline](https://developers.google.com/web/fundamentals/instant-and-offline/offline-cookbook/)  \n[workbox](https://developers.google.com/web/tools/workbox/)  \n[在 Vue SSR 中使用 Service Worker](https://zhuanlan.zhihu.com/p/31630322)  \n[SSR 架构项目实现离线可用](https://zhuanlan.zhihu.com/p/30791448)  \n[VUE SSR定制与使用心得](https://zhuanlan.zhihu.com/p/36017189)  \n[解密Vue SSR](https://zhuanlan.zhihu.com/p/35871344)\n\n## 总结\n\n目前可用Nuxt,vue-meta配合Koa实现SEO和首屏渲染的时间.\n如果剥离Vue全家桶实现SSR且与PWA的Workbox实现更好的优化和用户体验，以及程序良好的性能，需要较高的开发成本且对开发人员有较高的需求\n***SSR与PWA的配合使用，实际运作生产环境开发难度较高, CPU 是 SSR 的性能瓶颈***\n","publishedAt":"0201-03-11T19:04:17.000Z","status":"published","slug":"ssr-project-plan","author":3,"articletype":"Banner","created_at":"2021-07-29T07:01:17.931Z","updated_at":"2021-08-03T07:46:21.306Z","top":false,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":10,"name":"ELEMENT-UI","slug":"element-ui","created_at":"2021-07-29T07:12:04.629Z","updated_at":"2021-07-29T07:12:04.634Z","articles":[{"id":4,"title":"webpack2.6升级ts支持","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"0201-03-11T20:24:17.000Z","status":"published","slug":"webpack2-6-ts","author":3,"articletype":null,"created_at":"2021-07-29T07:13:40.603Z","updated_at":"2021-07-29T09:00:21.859Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":11,"name":"TYPESCRIPT","slug":"typescript","created_at":"2021-07-29T07:12:14.521Z","updated_at":"2021-07-29T07:12:14.527Z","articles":[{"id":4,"title":"webpack2.6升级ts支持","description":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n","content":"最近一直在改老项目的东西，但是因为体积太大的问题，热更新每次都要等好几秒，打📦发布测试环境也需要6-7分钟的时间，所以每次一个小改动需要发布就要等很久，加上之前说要优化打包速度，所以还是决定再折腾一下这个项目。\n\n## 方案\n\n这里因为babel已经升级到7了所以，想用happyPack + DllPlugin + babel7来试试看能提升多少速度。\n总体来说修改了一些webpack的配置和babel的配置，去掉了一些无用的依赖，package.json里面browserlist变成了 brow**s**erlist，更换了一些webpack的插件，主要有下：\n\n\u003e  移除的依赖\n\n```json\n{\n\t\"babel-core\": \"^6.26.3\",\n\t    \"babel-plugin-syntax-jsx\": \"^6.18.0\",  \n  \"babel-plugin-transform-runtime\": \"^6.22.0\",\n  \"babel-preset-latest\": \"^6.22.0\",  \n\"babel-preset-stage-2\": \"^6.22.0\",  \n\"babel-register\": \"^6.26.0\",  \n\"babel-runtime\": \"^6.23.0\",\n}\n```\n\n\u003e 更新或新增的依赖\n\n```json\n\"@babel/polyfill\": \"^7.6.0\",  \n\"@babel/runtime\": \"^7.6.3\",\n\"@babel/core\": \"^7.0.0\",  \n\"@babel/plugin-external-helpers\": \"^7.2.0\",  \n\"@babel/plugin-proposal-class-properties\": \"^7.0.0\",  \n\"@babel/plugin-proposal-decorators\": \"^7.0.0\",  \n\"@babel/plugin-proposal-export-namespace-from\": \"^7.0.0\",  \n\"@babel/plugin-proposal-function-sent\": \"^7.0.0\",  \n\"@babel/plugin-proposal-json-strings\": \"^7.0.0\",  \n\"@babel/plugin-proposal-numeric-separator\": \"^7.0.0\",  \n\"@babel/plugin-proposal-throw-expressions\": \"^7.0.0\",  \n\"@babel/plugin-syntax-dynamic-import\": \"^7.0.0\",  \n\"@babel/plugin-syntax-import-meta\": \"^7.0.0\",  \n\"@babel/plugin-syntax-jsx\": \"^7.0.0\",  \n\"@babel/plugin-transform-runtime\": \"^7.6.2\",  \n\"@babel/preset-env\": \"^7.0.0\",  \n\"@babel/preset-es2015\": \"^7.0.0-beta.53\",  \n\"@babel/preset-typescript\": \"^7.6.0\",  \n\"@babel/register\": \"^7.0.0\",  \n\"@babel/runtime-corejs2\": \"^7.0.0\",\n\"@vue/babel-plugin-transform-vue-jsx\": \"^1.0.0\",\n\"babel-loader\": \"^8.0.0\",\n\"clean-webpack-plugin\": \"^3.0.0\",\n\"happypack\": \"^5.0.1\",  \n\"html-webpack-include-assets-plugin\": \"^2.0.0\",\n\"uglifyjs-webpack-plugin\": \"^1.3.0\",\n\"webpack-bundle-analyzer\": \"^2.13.1\",\n\"webpack-merge\": \"^2.6.1\",  \n\"webpack-parallel-uglify-plugin\": \"^1.1.2\"\n```\n\n## 开工\n\n### happypack\n\n这里用的是[happypack](https://github.com/amireh/happypack)开启多线程打包，达到加速的效果,首先安装happypack的依赖.然后再在webpack.base.js增加配置，达到dev或者prod环境都可以加速的效果。\n\n\u003e 引入必要的依赖\n\n```javascript\nconst HappyPack = require('happypack') // 引用happypack\nconst os = require('os'); // 获取系统配置\n// 开启的线程池默认为4，这里直接取的是电脑的cpu线程数\nconst happyThreadPool = HappyPack.ThreadPool({ size: os.cpus().length }) \n```\n然后用happy-loader代替babel-loader，并且开启babel-loader的缓存，这里要注意，loader后面的**id=happyPack**对应的plugins里的id识，happypack不仅可以多线程打包js也可以打包css。\n\n```javascript\n// module.rules\n{\n    test: /\\.js$/,\n    // loader: 'babel-loader',  \n    loader: 'happypack/loader?id=happyPack',\n    include: [\n\t  resolve('src'),\n\t  resolve('test'),\n\t ],\n    exclude: /node_modules/\n},\n// plugins\nnew HappyPack({  \n  //用id来标识 happypack处理那里类文件  \n  id: 'happyPack',  \n  //如何处理  用法和loader 的配置一样  \n  loaders: [{  \n  loader: 'babel-loader',  \n  // here you configure babel:  \n  options: { babelrc: true, cacheDirectory: true }  \n }],  //共享进程池  \n  threadPool: happyThreadPool,  \n  //允许 HappyPack 输出日志  \n  verbose: true,  \n}),\n```\n\n### DllPlugin 和 DllReferencePlugin\n\nDllplgin插件的概念类似于C的动态链接库的作用，将更新次数很少或者几乎不更新的包打包在一起，拆分bundles，提升构建的速度，通过manifest.json确定包的版本和哈希值, 再用DllReferencePlugin使用该json文件来做映射依赖性。\n\n首先我们先修改`/config/index.js`新增我们的dll配置方便引用，再在`/build`的目录下新增`webpack.dll.conf.js`用来打包dll。\n\n\u003e /config/index.js\n\n```javascript\n// 新增配置\n...\ndll: {  \n  static: path.resolve(__dirname, '../static/lib'),  // dll存放路径 相对于项目的static/lib\n  list: {  // 多个包列表用来区分\n\t  vendor: ['vue/dist/vue.common.js','vue-router', 'vuex'],  \n\t  'asset': ['superagent']  \n}\n```\n\n\u003e /build/webpack.dll.conf.js\n\n```javascript\nvar path = require('path')\n\nvar webpack = require('webpack')\nvar CleanWebpackPlugin = require('clean-webpack-plugin')\n\nvar config = require('../config')\nvar __root = path.resolve(__dirname, '../')\n\nmodule.exports = {\n    context: __root, // 这里配置的context就是后面dll的context\n    entry: config.dll.list,\n    output: {\n        path: config.dll.static,\n        filename: '[name]-[chunkhash:7].dll.js',\n        library: 'lib_[name]',\n        // *** 这里不要添加libraryTarget，否则webpack打包时会出错。\n        // （提示是__WEBPACK__EXTERNAL__MODULE__xxx未定义） ***\n        // libraryTarget: 'umd'\n    },\n    resolve: {\n        modules: [path.resolve(__root, 'node_modules')],\n        extensions: ['.js', '.json'],\n        alias: {\n            'vue$': 'vue/dist/vue.esm.js'\n        }\n    },\n    // 这里没有写loaders，如果有需要可以自行添加loaders\n    plugins: [\n        // *** 这里很关键 ***\n        new webpack.DllPlugin({ // 因为上面写了context，所以这里可以不指定context\n            // 这里manifest的名字必须要有变量，因为类似上面的core和asset会分别创建一个manifest，\n            // 如果名称相同，manifest会生成不规范的json，在引用时会报错。\n            path: path.resolve(__root, 'static/manifest/[name].manifest.json'),\n            name: 'lib_[name]' // *** 这里的名字必须与output.library一致 ***\n        }),\n        // 这个是用来稳定hash值，防止出现webpack的hash出现莫名的变化\n        new webpack.HashedModuleIdsPlugin(),\n        new webpack.NamedChunksPlugin(),\n    ]\n}\n```\n然后在`package.json`添加`\"build:dll\": \"webpack --config build/webpack.dll.conf.js\"`用来生成dll，执行一下试试。\n\n![执行dll打包结果](https://oss.yangger.cn/assets/blog/667E3894-9F16-4E11-BE28-D2E9B3E27DCF.png)\n\n在项目的`static/lib`的目录下会生成对应的dll.js, 而且在`static/manifest`目录下也会生成对应的manifest.json。我们在每次打包之后需要将他们一起上传到git/svn等源码仓库，因为几乎不需要更新或者很少更新，所以只需要每次执行完之后记得上传到源码仓库即可。**如果不手动上传，那么在服务器打包代码之前一定要执行一次`npm run build:dll`命令**\n\n打包完dll之后，需要修改`webpack.base.js`让我们的在编译/打包的时候感受构建速度的提升。\n\n\u003e webpack.base.js\n\n```javascript\nconst HTMLWebpackIncludeAssetsPlugin = require('html-webpack-include-assets-plugin')  // 把我们的dll引入html\nconst CopyWebpackPlugin = require('copy-webpack-plugin') // 将dll文件拷贝到你的dist目录下\nconst __root = path.resolve(__dirname, '../')\n// 获取dll文件的manifest\nfunction getDllManifest() {\n    var plugins = []\n    Object.keys(config.dll.list).forEach((name) =\u003e {\n        plugins.push(\n            new webpack.DllReferencePlugin({\n                context: __root, // 这里的context必须与DllPlugin中的context保持一致\n                manifest: path.resolve(__root, 'static/manifest/[name].manifest.json').replace(\n                    /\\[name\\]/gi, name)\n            })\n        )\n    })\n    return plugins\n}\n\n//plugins\n\nplugins: [\n\t//...\n\t...getDllManifest(),\n\tnew HTMLWebpackIncludeAssetsPlugin({\n\t    append: false,\n\t    publicPath: config.build.assetsPublicPath,\n\t    assets: [{\n\t        path: config.build.assetsSubDirectory,\n\t        glob: '**/*.js',\n\t        globPath: config.dll.static\n        }],\n\t}),\n]\n```\n\n这样DllPlugin 和 DllReferencePlugin的配置基本就完成了\n\n### 其他构建的小优化和坑\n\n之前构建的时候会一直看到这样的错误: `# DefaultsError: 'warnings' is not a supported option`\n是因为UglifyJsPlugin更新了，配置方式不一样了，解决方案就是引用外部的[uglifyjs-webpack-plugin]([https://github.com/webpack-contrib/uglifyjs-webpack-plugin](https://github.com/webpack-contrib/uglifyjs-webpack-plugin))插件代替webpack自带的。\n\n修改如下:\n\n```javascript\n// new webpack.optimize.UglifyJsPlugin({  \n//   compress: {  \n//     warnings: false  \n//   },  \n//   sourceMap: true  \n// }),\nnew UglifyJsPlugin({  \n  cache: '.cache/',  \n  parallel: true,  \n}),  \n```\n\n然后在dev环境中新增[BundleAnalyzerPlugin](https://github.com/webpack-contrib/webpack-bundle-analyzer)用来查看到底是什么依赖或者哪个文件太大，可以针对性的做代码优化\n\n### babe7升级\n\n升级到babel7非常简单，可以看[官网升级指南](https://babeljs.io/docs/en/v7-migration)。\n其实主要更新有以下几点：\n  1. 自带支持TypeScript的支持，ts-loader或许可以不用了?\n  2. [移除stage-*](https://babeljs.io/blog/2018/07/27/removing-babels-stage-presets)\n  3. 以下预设都归并到\"@babel/preset-env\"了\n\t    -   `babel-preset-es2015`\n\t\t-   `babel-preset-es2016`\n\t\t-   `babel-preset-es2017`\n\t\t-   `babel-preset-latest`\n\t\t-  A combination of the above ^\n\t\n所以这里展示一下升级后`.bablerc`，仅供参考~\n\n\u003e .bablerc\n\n```json\n// {\n//   \"presets\": [\n//     [\"latest\", {\n//       \"es2015\": { \"modules\": false }\n//     }],\n//     \"stage-2\"\n//   ],\n//   \"plugins\": [\"transform-runtime\", \"transform-vue-jsx\"],\n//   \"comments\": false,\n//   \"env\": {\n//     \"test\": {\n//       \"presets\": [\"latest\", \"stage-2\"],\n//       \"plugins\": [ \"istanbul\" ]\n//     }\n//   }\n// }\n\n{  \n  \"presets\": [\"@babel/preset-env\", \"@babel/preset-typescript\", \"@vue/babel-preset-jsx\"],  \n  \"plugins\": [\"@babel/plugin-transform-runtime\", \"@babel/plugin-external-helpers\"]  \n}\n```\n\n## 测试\n\n到这里公司的元老级项目基本已经优化完毕了，在本地和服务器测试一下打包速度的区别试试.\n\n### mac 6核12线程\n\n\u003e 更新前打包速度\n\n![mac-更新前打包速度](https://oss.yangger.cn/assets/blog/FF249298-12D6-439E-A149-1A51EDF30C55.png)\n\n\n\u003e 更新后打包速度\n\n![mac-更新后打包速度](https://oss.yangger.cn/assets/blog/590E0034-4D68-4BE7-AEDA-7F0FFA4BB58E.png)\n\n### centos 单核双线程\n\n\u003e 更新前打包速度\n\n![centos-更新前打包速度](https://oss.yangger.cn/assets/blog/A535621B-69CB-4478-8C30-B547F4C33601.png)\n\n\u003e 更新后打包速度\n\n![centos-更新后打包速度](https://oss.yangger.cn/assets/blog/71D1F9DB-E95E-4FE3-A5D3-85AAE3C7F342.png)\n\n可以看到，无论是本地还是服务器，提升速度约等于3/5，相对于每次提交CI/CD走下来6-7分钟还是有很大提升的，起码泡☕️变成泡速溶☕️了hhhh。\n\n## 总结\n\n总的来说，在这些方法的推动下的构建速度优化还是有着肉眼可见的提升速度的，这里基于webpack2.x的提升方案的效果因项目而异，可能效果很大，也可能**没有效果**，这里只是提供一些思路，如果有更好的方案或者不足可以在评论区指出，谢谢🙏～","publishedAt":"0201-03-11T20:24:17.000Z","status":"published","slug":"webpack2-6-ts","author":3,"articletype":null,"created_at":"2021-07-29T07:13:40.603Z","updated_at":"2021-07-29T09:00:21.859Z","top":null,"image":{"id":5,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fe204377a5","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fe204377a5.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fe204377a5","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fe204377a5.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fe204377a5","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fe204377a5.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fe204377a5","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fe204377a5.png"}},"hash":"default_image_fe204377a5","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fe204377a5.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.854Z","updated_at":"2021-07-29T05:57:51.854Z"}}]},{"id":12,"name":"MARKDOWN","slug":"markdown","created_at":"2021-08-02T08:43:49.809Z","updated_at":"2021-08-02T08:43:49.820Z","articles":[{"id":5,"title":"markdown语法css调试","description":"专门用来调试markdown的语法","content":"# 这是一级标题\n\n## 这是二级标题\n\n### 这是三级标题\n\n#### 这是四级标题\n\n##### 这是五级标题\n\n###### 这是六级标题\n\n## 字体\n\n**这是加粗的文字**\n\n*这是倾斜的文字*`\n\n***这是斜体加粗的文字***\n\n~~这是加删除线的文字~~\n\n## 引用\n\n\u003e 这是引用的内容\n\n\u003e\u003e 这是引用的内容\n\n\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e\u003e 这是引用的内容\n\n## 分割线\n\n### 分割线---\n\n--- \n\n### 分割线 ***\n\n***\n\n## 图片\n\n![blockchain](https://ss0.bdstatic.com/70cFvHSh_Q1YnxGkpoWK1HF6hhy/it/u=702257389,1274025419\u0026fm=27\u0026gp=0.jpg \"区块链\")\n\n## 超链接\n\n[简书](http://jianshu.com)\n[百度](http://baidu.com)\n\n## 列表\n\n### 无序列表\n\n- 列表内容\n+ 列表内容\n* 列表内容\n\n### 有序列表\n\n1. 列表内容\n2. 列表内容\n3. 列表内容\n\n### 列表嵌套\n\n1. 苹果\n   1. 苹果6 \n   2. 苹果7 \n2. 安卓\n3. 哈哈\n\n- 测试\n   - 测试1\n   - 测试2\n- 笔记\n\n## 表格\n\n姓名|技能|排行\n--|:--:|--:\n刘备|哭|大哥\n关羽|打|二哥\n张飞|骂|三弟\n\n## 代码\n\n`代码`\n\n```css\narticle #markdown {}\narticle #markdown h1,\narticle #markdown h2,\narticle #markdown h3,\narticle #markdown h4,\narticle #markdown h5,\narticle #markdown h6 {\n    font-family: Inter;\n    font-style: normal;\n    font-weight: bold;\n    line-height: 1.5;\n    margin: 10px 0;\n}\narticle #markdown h1 {\n    font-size: 2.25rem;\n}\narticle #markdown h2 {\n    font-size: 1.625rem;\n}\n\narticle #markdown h3 {\n    font-size: 1.25rem;\n}\n\narticle #markdown h4,\narticle #markdown h5,\narticle #markdown h6 {\n    font-size: 1rem;\n}\n\n```\n\n## 正文\n\n这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字这是普通状态下的文字\n\n","publishedAt":"2021-08-02T04:00:00.000Z","status":"published","slug":"markdown-css","author":3,"articletype":"Items","created_at":"2021-08-02T08:44:15.613Z","updated_at":"2021-08-03T07:46:26.856Z","top":true,"image":{"id":4,"name":"favicon.png","alternativeText":null,"caption":null,"width":512,"height":512,"formats":{"thumbnail":{"name":"thumbnail_favicon.png","hash":"thumbnail_favicon_4d87055159","ext":".png","mime":"image/png","width":156,"height":156,"size":6.27,"path":null,"url":"/uploads/thumbnail_favicon_4d87055159.png"},"small":{"name":"small_favicon.png","hash":"small_favicon_4d87055159","ext":".png","mime":"image/png","width":500,"height":500,"size":28.98,"path":null,"url":"/uploads/small_favicon_4d87055159.png"}},"hash":"favicon_4d87055159","ext":".png","mime":"image/png","size":5.26,"url":"/uploads/favicon_4d87055159.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:51.548Z","updated_at":"2021-07-29T05:57:51.548Z"}}]}],"homepage":{"id":1,"created_at":"2021-07-29T05:57:49.996Z","updated_at":"2021-07-29T07:29:29.512Z","seo":{"id":1,"metaTitle":"Yangger Blog","metaDescription":"Yangger的博客","shareImage":{"id":1,"name":"default-image.png","alternativeText":null,"caption":null,"width":1208,"height":715,"formats":{"thumbnail":{"name":"thumbnail_default-image.png","hash":"thumbnail_default_image_fb02149608","ext":".png","mime":"image/png","width":245,"height":145,"size":27.69,"path":null,"url":"/uploads/thumbnail_default_image_fb02149608.png"},"large":{"name":"large_default-image.png","hash":"large_default_image_fb02149608","ext":".png","mime":"image/png","width":1000,"height":592,"size":423.75,"path":null,"url":"/uploads/large_default_image_fb02149608.png"},"medium":{"name":"medium_default-image.png","hash":"medium_default_image_fb02149608","ext":".png","mime":"image/png","width":750,"height":444,"size":250.27,"path":null,"url":"/uploads/medium_default_image_fb02149608.png"},"small":{"name":"small_default-image.png","hash":"small_default_image_fb02149608","ext":".png","mime":"image/png","width":500,"height":296,"size":114.01,"path":null,"url":"/uploads/small_default_image_fb02149608.png"}},"hash":"default_image_fb02149608","ext":".png","mime":"image/png","size":297.42,"url":"/uploads/default_image_fb02149608.png","previewUrl":null,"provider":"local","provider_metadata":null,"created_at":"2021-07-29T05:57:50.518Z","updated_at":"2021-07-29T05:57:50.518Z"}},"hero":{"id":1,"title":"Yangger Blog"}}},"__N_SSG":true},"page":"/[slug]","query":{"slug":"webpack2-6-ts"},"buildId":"jcy5ipSxzxBmo7PK3zeT2","assetPrefix":"https://cdn.yangger.cn","isFallback":false,"gsp":true,"appGip":true,"scriptLoader":[]}</script></body></html>